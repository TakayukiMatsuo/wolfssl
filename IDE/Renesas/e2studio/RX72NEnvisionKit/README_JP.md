README_JP.md

# このドキュメントについて


このドキュメントでは、ターゲットボード用のテストアプリケーションを構築して実行する方法について説明します。このドキュメントの英語版も、このファイルと同じ場所にあります。


# 1. プロジェクトの構成

このREADMEファイルを含むフォルダーには、次のものが含まれています:
  1. smc      --- スマートコンフィギュレータープロジェクトが保存されているフォルダー
  2. test     --- テストアプリケーションプロジェクトが保存されているフォルダ
  3. wolfssl  --- テストアプリケーションが使用するwolfsslライブラリのプロジェクトが保存されているフォルダー.
  4. common   --- 設定ファイルなどが保存されているフォルダ
  


# 2. プロジェクトのインポート


e2studioを起動した後、プロジェクトエクスプローラーペインを表示し、
[ファイル]メニュー> [ファイルシステムからプロジェクトを開く...]を選択します。
プロジェクトのインポートダイアログを表示されます。

ディレクトリボタンを押し、これら3つのプロジェクトを選択してインポートし、プロジェクトエクスプローラペインに表示させます。


# 3. smcプロジェクトでソースファイルを生成


smc.scfgファイルは、smcプロジェクトですでに準備されています。
このファイルをダブルクリックすると、Smart Configuratorパースペクティブが開きます。
複数のタブを持つ構成ペインを表示します。
[概要]タブで現在選択されているコンポーネントが、そのバージョンとともに一覧表示されます。
これらは、テストアプリケーションを実行するために既に設定済みです。
ボード情報とクロック設定も、RX72N EnvisionKitに併せて設定されています。

設定する必要があるポイントはボードに設定するIPアドレスです。
コンポーネントタブのr_t4_rxコンポーネント設定を選択して表示させます。次のプロパティの値
”DHCPが無効な場合のch0のIPアドレス”　の値を指定する必要があります。RX72N EnvisionKitに設定されているIPv4アドレスを環境に適した値に設定します。
これが設定する必要がある唯一の場所です。

設定を保存し、画面右上のソースファイル生成ボタンを押してソースファイルを生成します。

# 4. 生成されたソースファイルをtestプロジェクトにコピー


e2studioプロジェクトエクスプローラーペインでテストプロジェクトフォルダーを展開すると、"src/smc_gen"フォルダーが表示されます。 "smc_gen"フォルダを"test/src"フォルダにコピーして、"test/src/smc_gen"を作成します。 

フォルダーをコピーした後、IPアドレス、スタックサイズ、ヒープサイズなどの構成を変更しようとしない限り、smcプロジェクトを操作する必要はありません。Smart configuratorを使用して構成を変更した場合は、ソースファイルを生成してから、"test/src"フォルダーに再度コピーする必要があります。


# 5. テストプロジェクトの動作を選択

テストプロジェクトは、「test」という名前の実行可能ファイル（アプリケーション）を出力します。暗号化テスト、ベンチマーク、TLSクライアント、TLSサーバーからアプリケーションの動作（タイプ）を選択できます。

この選択は、"test/src/wolfssl_demo.h" 内の次のマクロ定義の1つを有効化することによって行われます。


  1. CRYPT_TEST -- このマクロは、テストアプリケーションを暗号化アルゴリズムテストベンチとして動作させます。 wolfSSLでサポートされているアルゴリズムがテストされ、その結果が"Renesas Debug Virtual Console"に表示されます。

  2. BENCHMARK  -- このマクロは、テストアプリケーションにベンチマークを実行させ、結果を表示します。暗号化アルゴリズムが実行され、その処理速度が測定されます。一部はH/Wアクセラレータで処理されます。結果は"Renesas Debug Virtual Console"に表示されます。

  3. TLS_CLIENT -- このマクロは、テストアプリケーションにTLSサーバーアプリケーションとのTLSハンドシェイクを実行させ、短いメッセージを暗号化された形式で交換させます。このテストの前に、TLSサーバーアプリケーションを実行し、クライアントにリッスンさせる必要があります。 wolfSSL/examples/Serverで提供される「サーバー」アプリケーションをTLSサーバーとして使用できます。サーバーアプリケーションの実行方法については、後の章で説明します。

  4. TSL_SERVER -- このマクロは、テストアプリケーションにこのTLSクライアントアプリケーションのTLSハンドシェイクを実行させ、暗号化された形式の短いメッセージを交換させます。 TLS_CLIENTの場合と同様に、テストにはTLSクライアントアプリケーションが必要です。

# 6. wolfsslプロジェクトとテストプロジェクトをビルド

ビルドする前に、上記の設定が完了していることを確認してください。
"wolfssl"と"test"の順にビルドします。これらの設定を変更する場合は、これらの2つのプロジェクトを再構築して、設定が反映されるようにすることをお勧めします。 


# 7. エミュレーターを使用してテストアプリケーションを実行

エミュレータ、ターゲットボード、PCをケーブルで接続した後、テスト用HardwareDebug.launchがすでに準備されています。
e2 studioで[実行]> [デバッグ]を選択して、デバッグを開始します。

デバッグパースペクティブが表示されたら、e2スタジオメニューの[Renesas Views]> [Debug]> [Renesas Debug Virtual Console]を選択します。
デバッグコンソールペインを表示します。テストアプリケーションの実行の進捗状況と結果がこのコンソールに出力されます。

# 8. 通信用のアプリケーションを準備

 "test/src/wolfssl_demo.h"でTLS_CLIENTまたはTLS_SERVERマクロを有効にする場合、テストアプリケーション用に通信パートナーアプリケーションを準備する必要があります。 wolfSSLパッケージは、それらのパートナーアプリケーションをサンプルプログラムとして提供します。

 「wolfSSLパッケージを構築する」と言うとき、それはwolfsslライブラリといくつかのサンプルアプリケーションを作ることを意味します。それでは、wolfSSLパッケージを作成しましょう。
 

 ## 8.1 Build a wolfSSL with Visual Studio on Windows 

 皆さんはきっとWindows環境で作業しているでしょう。その前提でwolfSSLを構築する最も簡単な方法を紹介しましょう。 その他の環境では、8.2を参照してください。wolfSSLパッケージのベースフォルダーには、wolfssl.slnとwolfssl64.slnがあります。 PCにVisualStudioがすでにインストールされている場合は、これらのソリューションファイルの1つをダブルクリックすると、wolfSSLを構築する準備が整います。

ソリューションエクスプローラペインに、7つのプロジェクトが表示されます。それらの中で、"client" および"server"プロジェクトは、RX72NEnvisionKitの通信パートナーアプリとして機能します。そこで今はこの2つのプロジェクトに焦点を当てます。いずれかのプロジェクトを展開すると、user_settings.hが表示されます。このファイルにマクロを追加して、これらのアプリをカスタマイズする必要があります。

追加する必要があるマクロは、ターゲットデバイスまたはwolfSSL自体の暗号化機能の制限に基づいています。現在、wolfSSLはRSAキー交換とRnesas RX72NとTSIPでのTLSハンドシェイクのためのAES-CBCモード暗号化をサポートしています。

user_settings.hを開いて、70行目辺りに次の4つのマクロを追加します。

```
#define WOLFSSL_STATIC_RSA 
#define HAVE_AESGCM
#define HAVE_AES_CBC
#define WOLFSSL_DH_CONST
```
追加後は以下の様になるはずです:

```
  #else
    /* The servers and clients */
    #define OPENSSL_EXTRA
    #define NO_PSK
    
    /* add following four macros */
    #define WOLFSSL_STATIC_RSA 
    #define HAVE_AESGCM
    #define HAVE_AES_CBC
    #define WOLFSSL_DH_CONST

  #endif
#endif /* HAVE_FIPS */
```

user_settings.hは7つのプロジェクト間で共有されるのでマクロの追加は一度で済みます。user_settings.hを編集した後、ソリューションをビルドして、これらの7つのサンプルアプリケーションをすべてビルドできます。


## 8.2 LinuxまたはそのバリアントでwolfSSLを構築する

通信パートナーアプリは、Windowsでのビルドに限定されません。 LinuxまたはバリアントOSとgcc/autoconfツールがある場合は、以下のマニュアルに従ってwolfSSLパッケージをビルドできます。

https://www.wolfssl.com/docs/wolfssl-manual/ch2/


# 9. テストアプリケーションの実行

## 9.1 CRYPT_TESTまたはBENCHMARK

セクション7で、テストアプリケーションをE2Studioで実行する準備ができています。
セクション5での選択が　CRYPT_TEST　または　BENCHMARK　のいずれかならばボードでテスト実行可能ファイルを実行するだけです。
テスト結果は "Renesas Debug Virtual Console" に表示されます。
結果が出力された後でもデバッグを停止できます。

## 9.2 TLS_CLINET

テストアプリケーションがTLS_Clientとして構築されている場合、セクション8で構築されたパートナーアプリを実行し、テストアプリからの接続を待ち受けさせる必要があります。パートナーアプリは"server.exe"です。コンソールを開き、次のように入力します。:

```
> server.exe -b -d -i
```
"server.exe" は、任意のIPアドレスのポート11111で永続的にリスニングを開始します。Windowsファイアウォールが"server.exe"をブロックし、あなたの承認を求める場合があります。次に、エミュレータからターゲットボードのテストアプリを実行できます。
まもなく、E2Studioの "Renesas Debug Virtual Console" に以下のメッセージが表示されます:

```
--Renesas Degug Virtual Console--

cipher : AES128-SHA
Received: I hear you fa shizzle!

cipher : AES128-SHA256
Received: I hear you fa shizzle!

cipher : AES256-SHA
Received: I hear you fa shizzle!

cipher : AES256-SHA256
Received: I hear you fa shizzle!
```

server.exeを起動したコマンドプロンプトにも、同様のメッセージが表示されます。 server.exeに-iオプションを渡しているので、Control-Cを入力するまで待機し続けます。


## 9.2 TLS_SERVER

このケースを試す前に、セクション3でボードに割り当てたIPアドレスを思い出しておいてください。ターゲットボードはポート11111でリッスンを開始します。今回は、パートナーアプリ（client.exe）の前にターゲットを実行する必要があります。
ターゲットボードでテストアプリの実行が開始されたら、オプション "-h target-board-ip-address"を指定してclient.exeを起動できます。

```
> client.exe -h XXX.XXX.XXX.XXX
```

# 10. H/Wアクセラレーションの使用を無効にする

TSIPがある場合とない場合の暗号化機能のパフォーマンスを比較したい場合があります。その場合は、"wolf-base/IDE/Renesas/e2studio/RX72NEnvisionKit/common/ user_settings.h"のマクロ "WOLFSSL_RENESAS_TSIP"をコメントアウトすることで、TSIPの使用を無効にできます。

```
-- user_settings.h --
  ... 
/* #define WOLFSSL_RENESAS_TSIP */
#define WOLFSSL_RENESAS_TSIP_VER  109
  ...
```

再ビルドされたテストアプリケーションは、全ての暗号化処理をソフトウェアのみで実行します。